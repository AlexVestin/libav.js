<!doctype html>
<html>
    <head>
        <title>LibAV Opus encoding test</title>
    </head>
    <body>
        <script type="text/javascript">LibAV = {base:".."}</script>
        <script type="text/javascript" src="../libav-1.4.1-default.js"></script>
        <script type="text/javascript">
            // This is a port of doc/examples/encode_audio.c, but using Opus
            function encode(ctx, frame, pkt) {
                var libav = LibAV;
                return libav.avcodec_send_frame(ctx, frame).then(function(ret) {
                    if (ret < 0)
                        throw new Error("Error sending the frame to the encoder");

                    return new Promise(function(res, rej) {
                        function packet() {
                            libav.avcodec_receive_packet(ctx, pkt).then(function(ret) {
                                if (ret === -libav.EAGAIN || ret === libav.AVERROR_EOF) {
                                    res(ret);
                                    return;
                                } else if (ret < 0) {
                                    rej(new Error("avcodec_receive_packet: " + ret));
                                    return;
                                }

                                return Promise.all([
                                    libav.AVPacket_data(pkt),
                                    libav.AVPacket_size(pkt)
                                ]);

                            }).then(function(ret) {
                                return libav.copyout_u8(ret[0], ret[1]);

                            }).then(function(ret) {
                                var div = document.createElement("div");
                                var part = "";
                                ret.forEach(function(b) {
                                    if (b < 16) part += "0";
                                    part += b.toString(16);
                                });
                                div.innerText = part;
                                document.body.appendChild(div);

                                return libav.av_packet_unref(pkt);
                            }).then(packet).catch(rej);
                        }
                        packet();
                    });
                });
            }

            function main() {
                var libav = LibAV;
                var codec, c, pkt, frame, frame_size;
                libav.avcodec_find_encoder_by_name("libopus").then(function(ret) {
                    codec = ret;
                    if (codec === 0)
                        throw new Error("Codec not found");
                    return libav.avcodec_alloc_context3(codec);

                }).then(function(ret) {
                    c = ret;
                    if (c === 0)
                        throw new Error("Could not allocate audio codec context");;
                    return Promise.all([
                        libav.ff_check_sample_fmt(codec, libav.AV_SAMPLE_FMT_FLT),
                        libav.AVCodecContext_set(c, {
                            bit_rate: 128000,
                            sample_fmt: libav.AV_SAMPLE_FMT_FLT,
                            sample_rate: 48000,
                            channel_layout: 4,
                            channels: 1
                        }),
                        libav.AVCodecContext_time_base_s(c, 1, 48000)
                    ]);

                }).then(function(ret) {
                    if (ret[0] === 0)
                        throw new Error("Encoder does not support sample format");
                    return libav.avcodec_open2(c, codec, 0);

                }).then(function(ret) {
                    if (ret < 0)
                        throw new Error("Could not open codec (" + ret + ")");
                    return Promise.all([
                        libav.av_packet_alloc(),
                        libav.av_frame_alloc(),
                        libav.AVCodecContext_frame_size(c)
                    ]);

                }).then(function(ret) {
                    pkt = ret[0];
                    frame = ret[1];
                    frame_size = ret[2];
                    return libav.AVFrame_set(frame, {
                        nb_samples: frame_size,
                        format: libav.AV_SAMPLE_FMT_FLT,
                        channel_layout: 4
                    });

                }).then(function() {
                    return libav.av_frame_get_buffer(frame, 0);

                }).then(function(ret) {
                    if (ret < 0)
                        throw new Error("Could not allocate audio data buffers");

                    // Form the loop into a promise
                    var t = 0;
                    var tincr = 2 * Math.PI * 440 / 48000;
                    var p = Promise.all([]);

                    for (var i = 0; i < 200; i++) (function(i) {
                        var samples;
                        p = p.then(function() {
                            return libav.av_frame_make_writable(frame);
                        }).then(function(ret) {
                            if (ret < 0)
                                throw new Error();
                            return libav.AVFrame_data0(frame);
                        }).then(function(ret) {
                            samples = ret;
                            var samplesIn = [];

                            for (var j = 0; j < frame_size; j++) {
                                samplesIn[j] = Math.sin(t);
                                t += tincr;
                            }

                            return libav.copyin_f32(samples, samplesIn);

                        }).then(function() {
                            return encode(c, frame, pkt);

                        });
                    })(i);

                    return p.then(function() {
                        return encode(c, 0, pkt);
                    });

                }).then(function() {
                    var div = document.createElement("div");
                    div.innerText = "Done!";
                    document.body.appendChild(div);

                    return Promise.all([
                        libav.av_frame_free_js(frame),
                        libav.av_packet_free_js(pkt),
                        libav.avcodec_free_context_js(c)
                    ]);

                }).then(function() {
                    // Nothing

                }).catch(function(err) {
                    alert(err);
                });
            }

            if (LibAV.ready) {
                main();
            } else {
                LibAV.onready = main;
            }
        </script>
    </body>
</html>
